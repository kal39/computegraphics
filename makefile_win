#======================================================================================================================#
# CONFIG
#======================================================================================================================#

#---- BASIC -----------------------------------------------------------------------------------------------------------#

LIBRARY        := microcanvas
LIBS           := -lmicrocanvas -lmicrocompute -lglfw3 -lgdi32 -lglu32 -lopengl32 -lm
FLAGS          := -Wall -Wextra -Wno-missing-braces -Wno-unused-parameter
DEFS           := 

#---- PROJECT STRUCTURE -----------------------------------------------------------------------------------------------#

INCLUDE_FOLDER := include
LIB_FOLDER     := lib
BUILD_FOLDER   := build
SRC_FOLDER     := src
OUT_FOLDER     := tmp
EXAMPLE_FOLDER := example

#======================================================================================================================#

CC                := gcc $(FLAGS) $(DEFS) -isystem $(INCLUDE_FOLDER) -isystem $(MINGW_PATH)/include -I $(SRC_FOLDER)
AR                := ar rcs
RM                := rm -rf
CD                := cd
CP                := cp
MKDIR             := mkdir -p
SRC_FOLDERS       := $(shell find $(SRC_FOLDER)/ -type d)
BUILD_SUB_FOLDERS := $(subst $(SRC_FOLDER)/,$(BUILD_FOLDER)/,$(SRC_FOLDERS))
C_FILES           := $(shell find $(SRC_FOLDER)/ -type f -name "*.c")
C_OBJECTS         := $(subst $(SRC_FOLDER)/,$(BUILD_FOLDER)/,$(subst .c,.o,$(C_FILES)))
EXAMPLE_C_FILES   := $(shell find $(EXAMPLE_FOLDER)/ -type f -name "*.c")
EXAMPLES          := $(subst $(EXAMPLE_FOLDER)/,$(OUT_FOLDER)/,$(subst .c,,$(EXAMPLE_C_FILES)))
STATIC_LIB        := $(LIB_FOLDER)/lib$(LIBRARY).a

ifeq ($(strip $(MINGW_PATH)),)
	$(error set MINGW_PATH=[[path to mingw root folder]], for example, [[C:\MinGW]])
endif

.PHONY: default all library example dependency doc clean

default: library doc

all: library examples doc

library: clean $(STATIC_LIB)

examples: $(EXAMPLES)

dependency: $(INCLUDE_FOLDER) $(LIB_FOLDER)
	$(CD) submodules/microcompute; \
	$(MAKE_COMMAND) -f makefile_win clean; \
	$(MAKE_COMMAND) -f makefile_win library
	$(CP) submodules/microcompute/include/microcompute.h $(INCLUDE_FOLDER)/microcompute.h
	$(CP) submodules/microcompute/lib/libmicrocompute.a $(LIB_FOLDER)/libmicrocompute.a

doc:
	python3 submodules/microdoc/doc_generator.py $(SRC_FOLDER)/$(LIBRARY).h doc.md

$(OUT_FOLDER):
	$(MKDIR) $(OUT_FOLDER)

$(INCLUDE_FOLDER):
	$(MKDIR) $(INCLUDE_FOLDER)

$(LIB_FOLDER):
	$(MKDIR) $(LIB_FOLDER)

$(BUILD_SUB_FOLDERS):
	$(MKDIR) $(BUILD_SUB_FOLDERS)

$(C_OBJECTS): $(BUILD_SUB_FOLDERS) $(C_FILES)
	$(CC) -c $(subst $(BUILD_FOLDER)/,$(SRC_FOLDER)/,$(subst .o,.c,$@)) -o $@

$(STATIC_LIB): dependency $(INCLUDE_FOLDER) $(LIB_FOLDER) $(C_OBJECTS)
	$(AR) $(STATIC_LIB) $(C_OBJECTS)
	$(CP) $(SRC_FOLDER)/$(LIBRARY).h $(INCLUDE_FOLDER)/$(LIBRARY).h

$(EXAMPLES): $(OUT_FOLDER) $(STATIC_LIB)
	$(CC) -g $(subst $(OUT_FOLDER)/,$(EXAMPLE_FOLDER)/,$@).c -o $@ -L$(LIB_FOLDER) $(LIBS)

clean:
	$(RM) $(BUILD_FOLDER) $(INCLUDE_FOLDER) $(LIB_FOLDER) $(OUT_FOLDER)